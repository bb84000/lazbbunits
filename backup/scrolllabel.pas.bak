unit ScrollLabel;

{$mode objfpc}{$H+}

interface

uses
  Classes, StdCtrls, ExtCtrls, SysUtils, LResources, Forms, Controls, Graphics, Dialogs;

type
  TScrollType = (scEnabled, scDisabled, scAuto);

  TScrollLabel = class(TCustomLabel)
  private
    FCaption: String;
    FScrollInterval:integer;
    FScrollIncrement: Integer;
    FScrollAutoString:string;
    FScroll: TScrollType;
    FScrollGraph: Boolean;
    CaptionCanvas: TCanvas;
    CaptionBmp: Tbitmap;
    CaptionRect: TRect;
    ScrollTimer: TTimer;
    Initialized: Boolean;
    ScrollText: String;
    txtHeight, txtWidth: Integer;
    ScrollBmp: TBitMap;
    ScrollRect:Trect;
    BkGndBmp:Tbitmap;
    BkGndRect: Trect;
    ScrollIndex: Integer;
    procedure OnTimer(Sender: TObject); virtual;
    //procedure CNDrawItem(var Message: TWMDrawItem); message CN_DRAWITEM;
    //procedure CMMouseEnter(var Message: TMessage); message CM_MOUSEENTER;
    //procedure CMMouseLeave(var Message: TMessage); message CM_MOUSELEAVE;
    procedure SetCaption(ACaption: string);
    procedure SetSCrollInterval(AScrollInterval:integer);
    procedure SetSCroll(Ascroll:TScrollType);
    procedure SetSCrollAutoString(AScrollAutoString:string);
    procedure SetSCrollGraph(AscrollGraph:Boolean);
    procedure Initialize;
  protected
  public
    constructor Create(AOwner: TComponent); override;
    destructor Destroy; override;
  published
    { Déclarations publiées }
    property Caption: string read FCaption write SetCaption;
    property ScrollIncrement: Integer read FScrollIncrement write FScrollIncrement;
    property ScrollInterval:integer read  FScrollInterval write SetSCrollInterval default 20;
    property Scroll:TScrollType read FSCroll write SetSCroll;
    property ScrollAutoString:string read FScrollAutoString write SetScrollAutoString ;
    property ScrollGraph: Boolean read FScrollGraph write SetScrollGraph;

  end;

procedure Register;

implementation

procedure Register;
begin
  {$I scrolllabel_icon.lrs}
  RegisterComponents('LazbbComponents',[TScrollLabel]);
end;

constructor TScrollLabel.Create(AOwner: TComponent);
begin
  inherited;
  //ControlStyle := Controlstyle + [csAcceptsControls] ;
 //if  csDesigning in ComponentState then Exit;
  FScroll:=scAuto;
  AutoSize:= False;
  FScrollInterval:=50;
  FScrollIncrement:= 1;
  FScrollGraph:= False;
  FCaption:='BtnScroll';
  FScrollAutoString:= '...';
  ScrollTimer:= TTimer.Create(self);
  //ScrollTimer.Interval:= FScrollInterval;
  ScrollTimer.Enabled:= False;
  ScrollTimer.OnTimer:= @OnTimer;
  Initialized:= False;
  ScrollIndex:= 0;
  inherited Layout:= Layout;
  inherited Caption:= FCaption;
  //if  csDesigning in ComponentState then Exit;
  //inherited Caption:= FCaption;

  CaptionCanvas:= TCanvas.Create;
  ScrollText:= '';
  ScrollBmp:= Tbitmap.Create;
  ScrollBmp.PixelFormat:= pf8bit;
  BkGndBmp:= Tbitmap.Create;
  BkGndBmp.PixelFormat:= pf8bit;
  CaptionBmp:= Tbitmap.Create;
end;

destructor TScrollLabel.Destroy;
begin
  if assigned(BkGndBmp) then BkGndBmp.Free;
  if assigned(ScrollBmp) then ScrollBmp.Free;
  if assigned(CaptionCanvas) then CaptionCanvas.Free;
  if assigned(ScrollTimer) then ScrollTimer.free;
  Inherited Destroy;
end;

{procedure TScrollLabel.CNDrawItem(var Message: TWMDrawItem);
begin
  Inherited;
  if csDesigning in ComponentState then exit;
  if not Initialized then
  begin
    Initialize;
    Initialized:= True;
  end;
  //if Themeservices.ThemesEnabled then exit;
end;

procedure TBtnScroll.CMMouseEnter(var Message: TMessage);
begin
  Inherited;
  if csDesigning in ComponentState then exit;
  if Initialized then Initialize;
end;

procedure TBtnScroll.CMMouseLeave(var Message: TMessage);
begin
  Inherited;
  if csDesigning in ComponentState then exit;
  if Initialized then Initialize;
end;  }


procedure TScrollLabel.SetCaption(ACaption: string);
begin
  if fCaption=ACaption then exit;
  FCaption:=ACaption;
  if csDesigning in ComponentState then inherited Caption:=FCaption;
  if Initialized then Initialize;
end;

procedure TScrollLabel.SetScrollInterval(AScrollInterval:integer);
begin
  FScrollInterval:=AScrollInterval;
  ScrollTimer.Interval:= FScrollInterval;
  if Initialized then Initialize;
end;

procedure TScrollLabel.SetSCroll(Ascroll:TScrollType);
begin
  if fScroll= Ascroll then exit;
  fsCroll:= AScroll;
  if Initialized then Initialize;
end;

procedure TScrollLabel.SetSCrollGraph(AscrollGraph:Boolean);
begin
  if fScrollGraph= AscrollGraph then exit;
  fsCrollGraph:= AScrollGraph;
  if Initialized then Initialize;
end;

procedure TScrollLabel.SetSCrollAutoString(AScrollAutoString:string);

begin
  if FSCrollAutoString= AScrollAutoString then exit;
  FSCrollAutoString:= AScrollAutoString;
  if Initialized then Initialize;
end;

procedure TScrollLabel.Initialize;
var
  SpaceWidth: Integer;
begin
  inherited Caption:= fCaption;
  ScrollTimer.Enabled:= False;
  // Scroll désactivé
  if FScroll = scDisabled then exit;
  //CaptionCanvas.handle:= GetDC(Handle);
  //CaptionCanvas.Font.Assign(Font);
  // Texte moins long que le bouton et scAuto
  //if Glyph.width=0 then
  SpaceWidth:= 0; // else SpaceWidth:= spacing;
  // Texte moins long que le bouton et scAuto
  if Canvas.TextWidth(FCaption) <= ClientWidth then
  begin
    if FScroll = scAuto then exit;
  end;
  // Alors on défile !
  if initialized then inherited Caption:= '';
  ScrollText:= FCaption+FScrollAutoString;
  TxtHeight:= CaptionCanvas.TextHeight(ScrollText);
  TxtWidth:= CaptionCanvas.TextWidth(ScrollText);
  CaptionRect.Top:= (height-TxtHeight) div 2;
  CaptionRect.Bottom:= CaptionRect.Top+TxtHeight;
  BkGndBmp.Width:= 1;
  BkGndBmp.Height:= TxtHeight;
  BkGndRect:= Rect(0, 0, 1, TxtHeight);
  CaptionRect.Left:= 1;
  CaptionRect.Right:= CaptionRect.Left+ClientWidth;
  BkGndBmp.Canvas.CopyRect(BkGndRect, CaptionCanvas,
                              Rect(CaptionRect.Left-1, CaptionRect.top, CaptionRect.Left, CaptionRect.Bottom));

  If fScrollGraph then
  begin
    ScrollBmp.Canvas.Font.Assign(Font);
    ScrollBmp.width:=  2*txtWidth;
    ScrollBmp.Height:= txtHeight;
    ScrollRect:= Rect(0,0,2*txtWidth,txtHeight);
    ScrollBmp.Canvas.StretchDraw(ScrollRect, BkGndBmp);
    ScrollBmp.Canvas.Brush.Style:= bsClear;
    ScrollBmp.Canvas.TextOut(0,0, ScrollText+ScrollText);
  end;


  SCrollTimer.Enabled:= True;
end;

procedure TScrollLabel.OnTimer(Sender: TObject);
var
  i: Integer;
  s: String;
begin
 if csDesigning in ComponentState then exit;
  If not IsWindowVisible(TForm(Owner).Handle) then exit;
  if not fSCrollGraph then
  begin
    ScrollText:= Copy(ScrollText, 2, Length(ScrollText) - 1) + Copy(ScrollText,1,1) ;
    s:= ScrollText;
    for i:= 0 to length(ScrollText)-1 do
      if CaptionCanvas.TextWidth(s) > CaptionRect.Right- CaptionRect.Left
      then s:= copy (s, 1, length(s)-1) else break ;
    inherited Caption:= s;
  end else
  begin
    if ScrollIndex=0 then Initialize;
    if ScrollIndex < (ScrollBmp.Width div 2)-1 then Inc(ScrollIndex, FScrollIncrement)  else
    begin
      ScrollIndex:= 0;
    end;
    CaptionCanvas.CopyRect(CaptionRect, ScrollBmp.Canvas, Rect(ScrollIndex,0,ScrollIndex+CaptionRect.Right-CaptionRect.left , txtHeight));
  end;
end;


end.
